#!/usr/bin/env bash

set -eo pipefail

function usage() {
  cat <<EOS
Usage:
   sync-agent-files.sh

Convert Claude Code configurations for Codex and Gemini CLI.

Project-level:
  - Skills:   .claude/skills/   -> .codex/skills/
  - Commands: .claude/commands/ -> .gemini/commands/

Global (\$CLAUDE_CONFIG_DIR):
  - commands/  -> ~/.gemini/commands/
  - skills/    -> ~/.codex/skills/
  - hooks      -> files/.gemini/settings.json
  - mcpServers -> files/.codex/config.toml, files/.gemini/settings.json
  - CLAUDE.md  -> files/.codex/AGENTS.md, files/.gemini/AGENTS.md
EOS
}

ENTRYPOINT=$(cd "$(dirname "${BASH_SOURCE[0]}")"; pwd)
ROOT=$(cd "${ENTRYPOINT}/.."; pwd)
CLAUDE_CONFIG_DIR="${CLAUDE_CONFIG_DIR:-$HOME/.config/claudex}"

while (( $# )); do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
    -*|--*)
      echo "Unsupported flag $1" 1>&2
      exit 1
      ;;
    *)
      shift
      ;;
  esac
done

convert_skill() {
  src="$1" dst="$2"
  content=$(cat "$src")
  [[ "$content" =~ ^--- ]] || { echo "[WARN] No frontmatter: $src"; return; }

  fm=$(echo "$content" | awk '/^---$/{if(++c==2)exit}c' | tail -n +2)
  name=$(echo "$fm" | awk -F': ' '/^name:/{print $2}')
  desc=$(echo "$fm" | awk -F': ' '/^description:/{$1=""; sub(/^ /, ""); print}')
  keywords=$(echo "$fm" | awk -F': ' '/^keywords:/{$1=""; sub(/^ /, ""); print}')
  body=$(echo "$content" | awk '/^---$/{if(++c==2){p=1;next}}p')

  [ "${#desc}" -gt 500 ] && desc="${desc:0:497}..."

  mkdir -p "$(dirname "$dst")"

  if [ -n "$keywords" ]; then
    short=$(echo "$keywords" | xargs -r)
    cat > "$dst" <<EOF
---
# Generated by sync-agent-files.sh. DO NOT EDIT.
name: ${name}
description: ${desc}
metadata:
  short-description: ${short}
---
${body}
EOF
  else
    cat > "$dst" <<EOF
---
# Generated by sync-agent-files.sh. DO NOT EDIT.
name: ${name}
description: ${desc}
---
${body}
EOF
  fi
  echo "$src -> $dst"
}

convert_command() {
  src="$1" dst="$2"
  content=$(cat "$src")
  [[ "$content" =~ ^--- ]] || { echo "[WARN] No frontmatter: $src"; return; }

  fm=$(echo "$content" | awk '/^---$/{if(++c==2)exit}c' | tail -n +2)
  desc=$(echo "$fm" | awk -F': ' '/^description:/{$1=""; sub(/^ /, ""); print}')
  body=$(echo "$content" | awk '/^---$/{if(++c==2){p=1;next}}p' | sed 's/\$ARGUMENTS/{{args}}/g')

  mkdir -p "$(dirname "$dst")"
  cat > "$dst" <<EOF
# Generated by sync-agent-files.sh. DO NOT EDIT.
description = "${desc}"
prompt = """
${body}
"""
EOF
  echo "$src -> $dst"
}

# Project skills
if [ -d "${ROOT}/.claude/skills" ]; then
  while IFS= read -r f; do
    name=$(dirname "$f" | xargs -r basename)
    convert_skill "$f" "${ROOT}/.codex/skills/${name}/SKILL.md"
  done < <(find "${ROOT}/.claude/skills" -name "SKILL.md" -type f)

  while IFS= read -r f; do
    rel="${f#"${ROOT}/.claude/skills/"}"
    mkdir -p "$(dirname "${ROOT}/.codex/skills/${rel}")"
    cp "$f" "${ROOT}/.codex/skills/${rel}"
  done < <(find "${ROOT}/.claude/skills" -path "*/reference/*" -type f)
fi

# Project commands
if [ -d "${ROOT}/.claude/commands" ]; then
  while IFS= read -r f; do
    name=$(basename "$f" .md)
    convert_command "$f" "${ROOT}/.gemini/commands/${name}.toml"
  done < <(find "${ROOT}/.claude/commands" -name "*.md" -type f)
fi

# Global configs
[ -d "$CLAUDE_CONFIG_DIR" ] || exit 0

# Global commands
if [ -d "${CLAUDE_CONFIG_DIR}/commands" ]; then
  while IFS= read -r f; do
    rel="${f#"${CLAUDE_CONFIG_DIR}/commands/"}"
    name="${rel%.md}"
    name="${name//\//:}"
    convert_command "$f" ~/.gemini/commands/${name}.toml
  done < <(find -L "${CLAUDE_CONFIG_DIR}/commands" -name "*.md" -type f)
fi

# Global skills
if [ -d "${CLAUDE_CONFIG_DIR}/skills" ]; then
  while IFS= read -r f; do
    name=$(dirname "$f" | xargs -r basename)
    convert_skill "$f" ~/.codex/skills/${name}/SKILL.md
  done < <(find -L "${CLAUDE_CONFIG_DIR}/skills" -name "SKILL.md" -type f)

  while IFS= read -r f; do
    rel="${f#"${CLAUDE_CONFIG_DIR}/skills/"}"
    mkdir -p "$(dirname ~/.codex/skills/${rel})"
    cp "$f" ~/.codex/skills/${rel}
  done < <(find -L "${CLAUDE_CONFIG_DIR}/skills" -path "*/reference/*" -type f)
fi

# Global hooks
if [ -f "${CLAUDE_CONFIG_DIR}/settings.json" ]; then
  hooks=$(jq -e '.hooks // empty' "${CLAUDE_CONFIG_DIR}/settings.json" 2>/dev/null) || hooks=""
  if [ -n "$hooks" ]; then
    mapped=$(echo "$hooks" | jq '
      to_entries | [.[] |
        select((.key == "SubagentStop") | not) |
        if .key == "PreToolUse" then .key = "BeforeTool"
        elif .key == "PostToolUse" then .key = "AfterTool"
        elif .key == "UserPromptSubmit" then .key = "BeforeAgent"
        elif .key == "Stop" then .key = "SessionEnd"
        else .
        end
      ] | from_entries
    ')

    dst="${ROOT}/files/home/kai/.gemini/settings.json"
    if [ -f "$dst" ]; then
      jq --argjson hooks "$mapped" '.hooks = $hooks' "$dst" > "${dst}.tmp" && mv "${dst}.tmp" "$dst"
    else
      mkdir -p "$(dirname "$dst")"
      echo "{\"hooks\": {}}" | jq --argjson hooks "$mapped" '.hooks += $hooks' > "$dst"
    fi
    echo "hooks -> $dst"
  fi
fi

# Global MCP servers
mcp=$(jq -e '.mcpServers // empty' "${CLAUDE_CONFIG_DIR}/.claude.json" 2>/dev/null) || mcp=""
if [ -n "$mcp" ]; then
  # Codex (TOML)
  dst="${ROOT}/files/home/kai/.codex/config.toml"
  mkdir -p "$(dirname "$dst")"
  [ -f "$dst" ] && awk '/^\[mcp_servers\./{skip=1} /^\[/{if(!/^\[mcp_servers\./)skip=0} !skip' "$dst" > "${dst}.tmp" && mv "${dst}.tmp" "$dst"
  if [ -f "$dst" ] && [ -s "$dst" ]; then
    sed -i --follow-symlinks 's/[[:space:]]*$//' "$dst"
    if [ -n "$(tail -c1 "$dst")" ]; then
      echo >> "$dst"
    fi
  fi
  echo "$mcp" | jq -r --arg display "$DISPLAY" 'to_entries[] | ((.value.env // {}) | if $display != "" then .DISPLAY = $display else . end) as $environment_variables | "[mcp_servers.\(.key)]\ncommand = \"\(.value.command)\"\nargs = \(.value.args | @json)\n" + (if ($environment_variables | length) > 0 then "[mcp_servers.\(.key).env]\n" + ($environment_variables | to_entries | map("\(.key|@json) = \(.value|@json)") | join("\n")) + "\n" else "" end)' >> "$dst"
  echo "mcpServers -> $dst"

  # Gemini (JSON)
  dst="${ROOT}/files/home/kai/.gemini/settings.json"
  [ -f "$dst" ] && jq --argjson mcp "$(echo "$mcp" | jq 'map_values(del(.type))')" '.mcpServers = $mcp' "$dst" > "${dst}.tmp" && mv "${dst}.tmp" "$dst"
  echo "mcpServers -> $dst"
fi

# Global user prompt
if [ -f "${CLAUDE_CONFIG_DIR}/CLAUDE.md" ]; then
  expanded=""
  while IFS= read -r line; do
    if [[ "$line" =~ ^@(.+)$ ]]; then
      f="${CLAUDE_CONFIG_DIR}/${BASH_REMATCH[1]}"
      [ -f "$f" ] && expanded="${expanded}$(cat "$f")"$'\n'
    else
      expanded="${expanded}${line}"$'\n'
    fi
  done < "${CLAUDE_CONFIG_DIR}/CLAUDE.md"

  # Common removals
  base=$(echo "$expanded" \
    | sed '/@[a-z-]*\s*エージェント/d' \
    | sed '/並列:/d' \
    | sed '/backgroundで実行/d' \
    | sed '/`codex` MCP/d' \
    | sed '/`gemini` MCP/d' \
    | sed '/OpenAI社からブロック/d' \
    | sed '/`Plan mode`/d')

  # Git restriction text
  git_restriction=$'\n\n# Git Usage Rules\n- You may use read-only git commands (e.g., `git status`, `git log`, `git diff`) to inspect the repository state.\n- You are STRICTLY FORBIDDEN from using git commands that modify the repository (e.g., `git add`, `git commit`, `git push`, `git checkout`, `git reset`).\n- Do NOT modify the contents of the `.git` directory directly.'

  # Codex: remove TodoWrite/AskUserQuestion, replace WebSearch
  codex=$(echo "$base" \
    | sed '/TodoWrite/d' \
    | sed '/AskUserQuestion/d' \
    | sed 's/WebSearch/web_search/g')
  codex="${codex}${git_restriction}"
  dst="${ROOT}/files/home/kai/.codex/AGENTS.md"
  mkdir -p "$(dirname "$dst")"
  { echo "<!-- Generated by sync-agent-files.sh. DO NOT EDIT. -->"; echo "$codex"; } > "$dst"
  echo "CLAUDE.md -> $dst"

  # Gemini: replace TodoWrite with write_todos, WebSearch with google_web_search
  gemini=$(echo "$base" \
    | sed 's/TodoWrite/write_todos/g' \
    | sed 's/WebSearch/google_web_search/g')
  gemini="${gemini}${git_restriction}"
  dst="${ROOT}/files/home/kai/.gemini/AGENTS.md"
  mkdir -p "$(dirname "$dst")"
  { echo "<!-- Generated by sync-agent-files.sh. DO NOT EDIT. -->"; echo "$gemini"; } > "$dst"
  echo "CLAUDE.md -> $dst"
fi
