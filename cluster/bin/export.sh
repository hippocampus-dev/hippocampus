#!/usr/bin/env bash

set -e

ENV_FILE_DIRECTORY=${XDG_CONFIG_HOME:-~/.config/hippocampus/cluster}
ENV_FILE_PATH=${ENV_FILE_DIRECTORY}/env.sh

DEFAULT_GITHUB_TOKEN=""
DEFAULT_OPENAI_API_KEY=""
DEFAULT_NOTIFICATION_SLACK_BOT_TOKEN=""
DEFAULT_CORTEX_SLACK_APP_TOKEN=""
DEFAULT_CORTEX_SLACK_BOT_TOKEN=""
DEFAULT_CORTEX_SLACK_SIGNING_SECRET=""
DEFAULT_TRANSLATOR_SLACK_APP_TOKEN=""
DEFAULT_TRANSLATOR_SLACK_BOT_TOKEN=""
DEFAULT_TRANSLATOR_SLACK_SIGNING_SECRET=""
DEFAULT_OAUTH2_PROXY_OAUTH_CLIENT_SECRET=""
DEFAULT_OAUTH2_PROXY_COOKIE_SECRET=$(cat /dev/urandom | tr -cd 'a-zA-Z0-9' | head -c 32)
DEFAULT_HIPPOCAMPUS_DEV_GITHUB_APP_PRIVATE_KEY=""
DEFAULT_CORTEX_GOOGLE_CLIENT_SECRET=""
DEFAULT_CORTEX_GOOGLE_PRE_ISSUED_REFRESH_TOKEN=""
DEFAULT_JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN=$(cat /dev/urandom | tr -cd 'a-zA-Z0-9' | head -c 64)
DEFAULT_DOCKER_CONFIG_JSON="data:;base64,$(cat ~/.docker/config.json | base64 -w0)"
DEFAULT_SLACK_LOGGER_TIDB_SLACK_USER_PASSWORD=$(cat /dev/urandom | tr -cd 'a-zA-Z0-9' | head -c 64)

if [ -f ${ENV_FILE_PATH} ]; then
  . ${ENV_FILE_PATH}
fi

read -e -i "${GITHUB_TOKEN:-$DEFAULT_GITHUB_TOKEN}" -p "Enter GitHub Token: " GITHUB_TOKEN
read -e -i "${OPENAI_API_KEY:-$DEFAULT_OPENAI_API_KEY}" -p "Enter OpenAI API Key: " OPENAI_API_KEY
read -e -i "${NOTIFICATION_SLACK_BOT_TOKEN:-$DEFAULT_NOTIFICATION_SLACK_BOT_TOKEN}" -p "Enter Notification's Slack Bot Token: " NOTIFICATION_SLACK_BOT_TOKEN
read -e -i "${CORTEX_SLACK_APP_TOKEN:-$DEFAULT_CORTEX_SLACK_APP_TOKEN}" -p "Enter Cortex's Slack App Token: " CORTEX_SLACK_APP_TOKEN
read -e -i "${CORTEX_SLACK_BOT_TOKEN:-$DEFAULT_CORTEX_SLACK_BOT_TOKEN}" -p "Enter Cortex's Slack Bot Token: " CORTEX_SLACK_BOT_TOKEN
read -e -i "${CORTEX_SLACK_SIGNING_SECRET:-$DEFAULT_CORTEX_SLACK_SIGNING_SECRET}" -p "Enter Cortex's Slack Signing Secret: " CORTEX_SLACK_SIGNING_SECRET
read -e -i "${CORTEX_GOOGLE_CLIENT_SECRET:-$DEFAULT_CORTEX_GOOGLE_CLIENT_SECRET}" -p "Enter Cortex's Google Client Secret: " CORTEX_GOOGLE_CLIENT_SECRET
read -e -i "${CORTEX_GOOGLE_PRE_ISSUED_REFRESH_TOKEN:-$DEFAULT_CORTEX_GOOGLE_PRE_ISSUED_REFRESH_TOKEN}" -p "Enter Cortex's Google Pre-Issued Refresh Token: " CORTEX_GOOGLE_PRE_ISSUED_REFRESH_TOKEN
read -e -i "${TRANSLATOR_SLACK_APP_TOKEN:-$DEFAULT_TRANSLATOR_SLACK_APP_TOKEN}" -p "Enter Translator's Slack App Token: " TRANSLATOR_SLACK_APP_TOKEN
read -e -i "${TRANSLATOR_SLACK_BOT_TOKEN:-$DEFAULT_TRANSLATOR_SLACK_BOT_TOKEN}" -p "Enter Translator's Slack Bot Token: " TRANSLATOR_SLACK_BOT_TOKEN
read -e -i "${TRANSLATOR_SLACK_SIGNING_SECRET:-$DEFAULT_TRANSLATOR_SLACK_SIGNING_SECRET}" -p "Enter Translator's Slack Signing Secret: " TRANSLATOR_SLACK_SIGNING_SECRET
read -e -i "${OAUTH2_PROXY_OAUTH_CLIENT_SECRET:-$DEFAULT_OAUTH2_PROXY_OAUTH_CLIENT_SECRET}" -p "Enter oauth2-proxy's OAuth Client Secret: " OAUTH2_PROXY_OAUTH_CLIENT_SECRET
read -e -i "${OAUTH2_PROXY_COOKIE_SECRET:-$DEFAULT_OAUTH2_PROXY_COOKIE_SECRET}" -p "Enter oauth2-proxy's Cookie Secret: " OAUTH2_PROXY_COOKIE_SECRET
read -e -i "${HIPPOCAMPUS_DEV_GITHUB_APP_PRIVATE_KEY:-$DEFAULT_HIPPOCAMPUS_DEV_GITHUB_APP_PRIVATE_KEY}" -p "Enter hippocampus-dev's GitHub App Private Key: " HIPPOCAMPUS_DEV_GITHUB_APP_PRIVATE_KEY
read -e -i "${JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN:-$DEFAULT_JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN}" -p "Enter JupyterHub ConfigurableProxy Auth Token: " JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN
read -e -i "${DOCKER_CONFIG_JSON:-$DEFAULT_DOCKER_CONFIG_JSON}" -p "Enter Docker Config JSON: " DOCKER_CONFIG_JSON
read -e -i "${SLACK_LOGGER_TIDB_SLACK_USER_PASSWORD:-$DEFAULT_SLACK_LOGGER_TIDB_SLACK_USER_PASSWORD}" -p "Enter slack-logger's TiDB slack_user Password: " SLACK_LOGGER_TIDB_SLACK_USER_PASSWORD

export GITHUB_TOKEN
export OPENAI_API_KEY
export NOTIFICATION_SLACK_BOT_TOKEN
export CORTEX_SLACK_APP_TOKEN
export CORTEX_SLACK_BOT_TOKEN
export CORTEX_SLACK_SIGNING_SECRET
export CORTEX_GOOGLE_CLIENT_SECRET
export CORTEX_GOOGLE_PRE_ISSUED_REFRESH_TOKEN
export TRANSLATOR_SLACK_APP_TOKEN
export TRANSLATOR_SLACK_BOT_TOKEN
export TRANSLATOR_SLACK_SIGNING_SECRET
export OAUTH2_PROXY_OAUTH_CLIENT_SECRET
export OAUTH2_PROXY_COOKIE_SECRET
export HIPPOCAMPUS_DEV_GITHUB_APP_PRIVATE_KEY
export JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN
export DOCKER_CONFIG_JSON
export SLACK_LOGGER_TIDB_SLACK_USER_PASSWORD

mkdir -p ${ENV_FILE_DIRECTORY}
cat <<EOS > ${ENV_FILE_PATH}
GITHUB_TOKEN="${GITHUB_TOKEN}"
OPENAI_API_KEY="${OPENAI_API_KEY}"
NOTIFICATION_SLACK_BOT_TOKEN="${NOTIFICATION_SLACK_BOT_TOKEN}"
CORTEX_SLACK_APP_TOKEN="${CORTEX_SLACK_APP_TOKEN}"
CORTEX_SLACK_BOT_TOKEN="${CORTEX_SLACK_BOT_TOKEN}"
CORTEX_SLACK_SIGNING_SECRET="${CORTEX_SLACK_SIGNING_SECRET}"
CORTEX_GOOGLE_CLIENT_SECRET="${CORTEX_GOOGLE_CLIENT_SECRET}"
CORTEX_GOOGLE_PRE_ISSUED_REFRESH_TOKEN="${CORTEX_GOOGLE_PRE_ISSUED_REFRESH_TOKEN}"
TRANSLATOR_SLACK_APP_TOKEN="${TRANSLATOR_SLACK_APP_TOKEN}"
TRANSLATOR_SLACK_BOT_TOKEN="${TRANSLATOR_SLACK_BOT_TOKEN}"
TRANSLATOR_SLACK_SIGNING_SECRET="${TRANSLATOR_SLACK_SIGNING_SECRET}"
OAUTH2_PROXY_OAUTH_CLIENT_SECRET="${OAUTH2_PROXY_OAUTH_CLIENT_SECRET}"
OAUTH2_PROXY_COOKIE_SECRET="${OAUTH2_PROXY_COOKIE_SECRET}"
HIPPOCAMPUS_DEV_GITHUB_APP_PRIVATE_KEY="${HIPPOCAMPUS_DEV_GITHUB_APP_PRIVATE_KEY}"
JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN="${JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN}"
DOCKER_CONFIG_JSON="${DOCKER_CONFIG_JSON}"
SLACK_LOGGER_TIDB_SLACK_USER_PASSWORD="${SLACK_LOGGER_TIDB_SLACK_USER_PASSWORD}"
EOS
