#!/usr/bin/env bash

set -eo pipefail

ENV_FILE_DIRECTORY=${XDG_CONFIG_HOME:-/home/kai/.config/hippocampus/cluster}
ENV_FILE_PATH=${ENV_FILE_DIRECTORY}/env.sh

DEFAULT_GITHUB_TOKEN=""
DEFAULT_OPENAI_API_KEY=""
DEFAULT_NOTIFICATIONS_SLACK_BOT_TOKEN=""
DEFAULT_SLACK_APP_TOKEN=""
DEFAULT_SLACK_BOT_TOKEN=""
DEFAULT_SLACK_SIGNING_SECRET=""
DEFAULT_OAUTH2_PROXY_GITHUB_CLIENT_ID=""
DEFAULT_OAUTH2_PROXY_GITHUB_CLIENT_SECRET=""
DEFAULT_OAUTH2_PROXY_COOKIE_SECRET=$(cat /dev/urandom | tr -cd 'a-zA-Z0-9' | head -c 32)
DEFAULT_GOOGLE_CLIENT_ID=""
DEFAULT_GOOGLE_CLIENT_SECRET=""
DEFAULT_GOOGLE_PRE_ISSUED_REFRESH_TOKEN=""
DEFAULT_JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN=$(cat /dev/urandom | tr -cd 'a-zA-Z0-9' | head -c 64)
DEFAULT_DOCKER_CONFIG_JSON="data:;base64,$(cat /home/kai/.docker/config.json | base64 -w0)"

[ -e $ENV_FILE_PATH ] && . $ENV_FILE_PATH

read -e -i "${GITHUB_TOKEN:-$DEFAULT_GITHUB_TOKEN}" -p "Enter GitHub Token: " GITHUB_TOKEN
read -e -i "${OPENAI_API_KEY:-$DEFAULT_OPENAI_API_KEY}" -p "Enter OpenAI API Key: " OPENAI_API_KEY
read -e -i "${NOTIFICATIONS_SLACK_BOT_TOKEN:-$DEFAULT_NOTIFICATIONS_SLACK_BOT_TOKEN}" -p "Enter notifications Slack Bot Token: " NOTIFICATIONS_SLACK_BOT_TOKEN
read -e -i "${SLACK_APP_TOKEN:-$DEFAULT_SLACK_APP_TOKEN}" -p "Enter Slack App Token: " SLACK_APP_TOKEN
read -e -i "${SLACK_BOT_TOKEN:-$DEFAULT_SLACK_BOT_TOKEN}" -p "Enter Slack Bot Token: " SLACK_BOT_TOKEN
read -e -i "${SLACK_SIGNING_SECRET:-$DEFAULT_SLACK_SIGNING_SECRET}" -p "Enter Slack Signing Secret: " SLACK_SIGNING_SECRET
read -e -i "${OAUTH2_PROXY_GITHUB_CLIENT_ID:-$DEFAULT_OAUTH2_PROXY_GITHUB_CLIENT_ID}" -p "Enter oauth2-proxy GitHub Client ID: " OAUTH2_PROXY_GITHUB_CLIENT_ID
read -e -i "${OAUTH2_PROXY_GITHUB_CLIENT_SECRET:-$DEFAULT_OAUTH2_PROXY_GITHUB_CLIENT_SECRET}" -p "Enter oauth2-proxy GitHub Client Secret: " OAUTH2_PROXY_GITHUB_CLIENT_SECRET
read -e -i "${OAUTH2_PROXY_COOKIE_SECRET:-$DEFAULT_OAUTH2_PROXY_COOKIE_SECRET}" -p "Enter oauth2-proxy Cookie Secret: " OAUTH2_PROXY_COOKIE_SECRET
read -e -i "${GOOGLE_CLIENT_ID:-$DEFAULT_GOOGLE_CLIENT_ID}" -p "Enter Google Client ID: " GOOGLE_CLIENT_ID
read -e -i "${GOOGLE_CLIENT_SECRET:-$DEFAULT_GOOGLE_CLIENT_SECRET}" -p "Enter Google Client Secret: " GOOGLE_CLIENT_SECRET
read -e -i "${GOOGLE_PRE_ISSUED_REFRESH_TOKEN:-$DEFAULT_GOOGLE_PRE_ISSUED_REFRESH_TOKEN}" -p "Enter Google Pre-Issued Refresh Token: " GOOGLE_PRE_ISSUED_REFRESH_TOKEN
read -e -i "${JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN:-$DEFAULT_JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN}" -p "Enter JupyterHub ConfigurableProxy Auth Token: " JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN
read -e -i "${DOCKER_CONFIG_JSON:-$DEFAULT_DOCKER_CONFIG_JSON}" -p "Enter Docker Config JSON: " DOCKER_CONFIG_JSON

export GITHUB_TOKEN
export OPENAI_API_KEY
export NOTIFICATIONS_SLACK_BOT_TOKEN
export SLACK_APP_TOKEN
export SLACK_BOT_TOKEN
export SLACK_SIGNING_SECRET
export OAUTH2_PROXY_GITHUB_CLIENT_ID
export OAUTH2_PROXY_GITHUB_CLIENT_SECRET
export OAUTH2_PROXY_COOKIE_SECRET
export GOOGLE_CLIENT_ID
export GOOGLE_CLIENT_SECRET
export GOOGLE_PRE_ISSUED_REFRESH_TOKEN
export JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN
export DOCKER_CONFIG_JSON

mkdir -p $ENV_FILE_DIRECTORY
cat <<EOS > $ENV_FILE_PATH
GITHUB_TOKEN="$GITHUB_TOKEN"
OPENAI_API_KEY="$OPENAI_API_KEY"
NOTIFICATIONS_SLACK_BOT_TOKEN="$NOTIFICATIONS_SLACK_BOT_TOKEN"
SLACK_APP_TOKEN="$SLACK_APP_TOKEN"
SLACK_BOT_TOKEN="$SLACK_BOT_TOKEN"
SLACK_SIGNING_SECRET="$SLACK_SIGNING_SECRET"
OAUTH2_PROXY_GITHUB_CLIENT_ID="$OAUTH2_PROXY_GITHUB_CLIENT_ID"
OAUTH2_PROXY_GITHUB_CLIENT_SECRET="$OAUTH2_PROXY_GITHUB_CLIENT_SECRET"
OAUTH2_PROXY_COOKIE_SECRET="$OAUTH2_PROXY_COOKIE_SECRET"
GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID"
GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET"
GOOGLE_PRE_ISSUED_REFRESH_TOKEN="$GOOGLE_PRE_ISSUED_REFRESH_TOKEN"
JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN="$JUPYTERHUB_CONFIGPROXY_AUTH_TOKEN"
DOCKER_CONFIG_JSON="$DOCKER_CONFIG_JSON"
EOS
