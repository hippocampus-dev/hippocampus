<label @metrics>
  <match kubernetes.var.log.containers.**_istio-proxy-**>
    @type relabel
    @label @envoy-metric
  </match>

  <match kubernetes.var.log.containers.events-logger-**>
    @type relabel
    @label @events-logger-metric
  </match>

  <match kubernetes.var.log.containers.kube-apiserver-**>
    @type relabel_filter

    <rule>
      key $.message
      pattern /unable to load root certificate/
      label @log-filtered-metrics/kube-apiserver-unable-to-load-root-certificate
    </rule>

    # https://github.com/kubernetes/kubernetes/blob/e3c1777f7d1e1ad0259b43039e6ba6612232c065/pkg/util/conntrack/conntrack.go#L55
    <rule>
      key $.message
      pattern /error deleting connection tracking state for UDP service IP/
      label @log-filtered-metrics/kube-apiserver-error-deleting-connection
    </rule>

    <rule>
      key $.responseStatus.message
      pattern /the server could not find the requested resource/
      label @log-filtered-metrics/kube-apiserver-could-not-find-metric
    </rule>
  </match>
</label>

<label @envoy-metric>
  <filter **>
    @type grep
    <regexp>
      key $.structural_message.vhost
      pattern /.+/
    </regexp>
  </filter>
  <match **>
    @type relabel
    @label @envoy-metric/export
  </match>
</label>

<label @envoy-metric/export>
  <match **>
    @type prometheus

    <metric>
      name envoy_requests_total
      type counter
      desc The total number of http request.
    </metric>

    <metric>
      name envoy_request_duration_milliseconds
      type histogram
      buckets 1, 3, 5, 10, 25, 50
      desc The histogram of http request by reqtime.
      key $.structural_message.reqtime
    </metric>

    <labels>
      vhost $.structural_message.vhost
      method $.structural_message.method
      uri $.structural_message.uri
      status $.structural_message.status
    </labels>
  </match>
</label>

<label @events-logger-metric>
  <filter **>
    @type grep
    <regexp>
      key $.structural_message.reason
      pattern /.+/
    </regexp>
  </filter>
  <match **>
    @type relabel
    @label @events-logger-metric/export
  </match>
</label>

<label @events-logger-metric/export>
  <match **>
    @type prometheus

    <metric>
      name kube_events_total
      type counter
      desc The total number of kubernetes events.
    </metric>

    <labels>
      apiVersion $.structural_message.regarding.apiVersion
      kind $.structural_message.regarding.kind
      namespace $.structural_message.regarding.namespace
      name $.structural_message.regarding.name
      reason $.structural_message.reason
    </labels>
  </match>
</label>

<label @log-filtered-metrics/kube-apiserver-unable-to-load-root-certificate>
  <filter **>
    @type record_modifier
    <record>
      kind kube-apiserver-unable-to-load-root-certificate
    </record>
  </filter>
  <match **>
    @type relabel
    @label @log-filtered-metrics
  </match>
</label>

<label @log-filtered-metrics/kube-apiserver-error-deleting-connection>
  <filter **>
    @type record_modifier
    <record>
      kind kube-apiserver-error-deleting-connection
    </record>
  </filter>
  <match **>
    @type relabel
    @label @log-filtered-metrics
  </match>
</label>

<label @log-filtered-metrics/kube-apiserver-could-not-find-metric>
  <filter **>
    @type grep
    <regexp>
      key $.user.username
      pattern /^system:serviceaccount:/
    </regexp>
  </filter>
  <filter **>
    @type record_modifier
    <record>
      kind kube-api-server-could-not-find
    </record>
  </filter>
  <match **>
    @type relabel
    @label @log-filtered-metrics
  </match>
</label>

<label @log-filtered-metrics/export>
  <match **>
    @type prometheus

    <metric>
      name filtered_logs_total
      type counter
      desc The total number of filtered logs.
    </metric>

    <labels>
      kind $.kind
    </labels>
  </match>
</label>
