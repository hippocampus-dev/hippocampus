apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicy
metadata:
  name: pods.mutating.kaidotio.github.io
spec:
  failurePolicy: Ignore
  reinvocationPolicy: IfNeeded
  matchConstraints:
    resourceRules:
      - apiGroups:
          - ""
        apiVersions:
          - "*"
        resources:
          - pods
        operations:
          - CREATE
  mutations:
    - patchType: ApplyConfiguration
      applyConfiguration:
        expression: >
          Object {
            spec: Object.spec{
              initContainers: object.spec.?initContainers.orValue([]).filter(
                initContainer, quantity(initContainer.resources.?limits['nvidia.com/gpu'].orValue("0")).asInteger() == 0
              ).map(
                initContainer,
                Object.spec.initContainers {
                  name: initContainer.name,
                  env: [
                    Object.spec.initContainers.item.env {
                      name: 'NVIDIA_VISIBLE_DEVICES',
                      value: 'none',
                    }
                  ]
                }
              ),
              containers: object.spec.containers.filter(
                container, quantity(container.resources.?limits['nvidia.com/gpu'].orValue("0")).asInteger() == 0
              ).map(
                container,
                Object.spec.containers {
                  name: container.name,
                  env: [
                    Object.spec.containers.item.env {
                      name: 'NVIDIA_VISIBLE_DEVICES',
                      value: 'none',
                    }
                  ]
                }
              )
            }
          }
