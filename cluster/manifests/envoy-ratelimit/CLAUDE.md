# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is the envoy-ratelimit service, a rate limiting component for the Hippocampus Kubernetes cluster. It provides API rate limiting using Envoy's rate limit service protocol, backed by Memcached for distributed counter storage.

## Common Development Commands

### Deployment Commands
- `kubectl apply -k overlays/dev/` - Deploy the complete rate limit service to the development environment
- `kubectl -n envoy-ratelimit get pods` - Check the status of rate limit pods
- `kubectl -n envoy-ratelimit logs -f deployment/envoy-ratelimit` - View rate limit service logs
- `kubectl -n envoy-ratelimit describe configmap general.yaml` - View current rate limit rules

### Configuration Management
- `kubectl -n envoy-ratelimit edit configmap general.yaml` - Edit rate limit rules directly (for quick testing)
- `kubectl -n envoy-ratelimit rollout restart deployment/envoy-ratelimit` - Restart the service to pick up config changes

### Testing Rate Limits
- Test with curl: `curl -H "User-Agent: bot" <target-url>` - Should be rate limited after 4 requests/second
- Monitor metrics: `kubectl -n envoy-ratelimit port-forward svc/envoy-ratelimit-statsd 9102:9102` then access http://localhost:9102/metrics

## High-Level Architecture

### Directory Structure
```
envoy-ratelimit/
├── base/                     # Base Kubernetes manifests
│   ├── deployment.yaml      # Core rate limit service deployment
│   ├── horizontal_pod_autoscaler.yaml
│   ├── pod_disruption_budget.yaml
│   └── service.yaml
└── overlays/
    └── dev/                 # Development environment overlay
        ├── files/           # Rate limit configuration files
        │   ├── general.yaml     # General rate limit rules (bot protection)
        │   └── reporting-server.yaml  # Reporting endpoint rate limits
        ├── memcached/       # Memcached StatefulSet and McRouter proxy
        ├── statsd-exporter/ # Metrics collection and export
        └── patches/         # Kustomize patches for base resources
```

### Key Components

1. **Rate Limit Service**: The main envoy-ratelimit deployment that evaluates rate limit requests from Envoy proxies
2. **Memcached Cluster**: Distributed storage for rate limit counters, accessed via McRouter for connection pooling
3. **StatsD Exporter**: Collects rate limit metrics and exposes them in Prometheus format
4. **Istio Integration**: Uses Istio sidecars for mTLS communication between components

### Rate Limit Configuration Format

Rate limit rules are defined in YAML files under `overlays/dev/files/`. Example structure:
```yaml
domain: <domain-name>
descriptors:
- key: <header-name>
  value: <regex-pattern>
  rate_limit:
    unit: second|minute|hour|day
    requests_per_unit: <number>
```

### Integration Points

- **Envoy Proxies**: Send rate limit check requests using the Envoy rate limit service protocol
- **Istio Service Mesh**: Provides mTLS, traffic management, and observability
- **Prometheus/Grafana**: Metrics are exported for monitoring and alerting
- **ConfigMaps**: Rate limit rules are mounted as ConfigMaps, allowing dynamic updates

### Development Workflow

1. **Modifying Rate Limit Rules**:
   - Edit files in `overlays/dev/files/`
   - Apply changes with `kubectl apply -k overlays/dev/`
   - ConfigMaps are automatically regenerated by Kustomize

2. **Adding New Rate Limit Domains**:
   - Create a new YAML file in `overlays/dev/files/`
   - Add it to the `configMapGenerator` section in `overlays/dev/kustomization.yaml`
   - Mount the ConfigMap in the deployment via patches

3. **Scaling Considerations**:
   - HorizontalPodAutoscaler manages automatic scaling based on CPU/memory
   - Memcached cluster can be scaled by modifying the StatefulSet replicas
   - TopologySpreadConstraints ensure pods are distributed across zones and nodes

### Important Environment Variables

Set in `overlays/dev/patches/deployment.yaml`:
- `BACKEND_TYPE`: Always "memcache" for this deployment
- `MEMCACHE_HOST_PORT`: Points to the McRouter service
- `USE_STATSD`: Enables metrics collection
- `RUNTIME_ROOT`: Base directory for configuration files (/data)
- `LOG_LEVEL`: Controls logging verbosity (default: info)