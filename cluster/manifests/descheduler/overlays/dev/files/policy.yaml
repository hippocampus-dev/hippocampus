apiVersion: descheduler/v1alpha2
kind: DeschedulerPolicy
profiles:
  - name: default
    pluginConfig:
      - name: DefaultEvictor
        args:
          evictSystemCriticalPods: true
          evictFailedBarePods: true
          evictLocalStoragePods: true
          nodeFit: true
          ignorePodsWithoutPDB: true
      - name: RemovePodsViolatingTopologySpreadConstraint
        args:
          topologyBalanceNodeFit: true
          constraints:
            - DoNotSchedule
            - ScheduleAnyway
          labelSelector:
            matchExpressions:
              # statefulset often has PVC so cannot be rescheduled
              - key: statefulset.kubernetes.io/pod-name
                operator: DoesNotExist
              # descheduler counts completed pods as violators
              - key: job-name
                operator: DoesNotExist
      # This strategy finds nodes that are under utilized and evicts pods, if possible, from other nodes in the hope that recreation of evicted pods will be scheduled on these underutilized nodes. The parameters of this strategy are configured under nodeResourceUtilizationThresholds.
      - name: LowNodeUtilization
        args:
          thresholds:
            cpu : 30
            memory: 50
          targetThresholds:
            cpu : 60
            memory: 80
          metricsUtilization:
            metricsServer: true
      # Remove ContainerStatusUnknown pods(https://github.com/kubernetes/kubernetes/issues/105467)
      - name: RemoveFailedPods
        args:
          reasons:
            - Evicted
          includingInitContainers: true
    plugins:
      deschedule:
        enabled:
          - RemovePodsViolatingTopologySpreadConstraint
          - RemoveFailedPods
      balance:
        enabled:
          - LowNodeUtilization
