apiVersion: batch/v1
kind: Job
metadata:
  name: adhoc-curl
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  completions: 1
  parallelism: 1
  completionMode: Indexed
  backoffLimitPerIndex: 6
  maxFailedIndexes: 1
  podReplacementPolicy: Failed
  podFailurePolicy:
    rules:
      - action: FailJob
        onExitCodes:
          operator: In
          values:
            - 127
      - action: Ignore
        onPodConditions:
          - type: DisruptionTarget
            status: "True"
  template:
    metadata:
      labels:
        app.kubernetes.io/name: sample
        app.kubernetes.io/component: elasticsearch-curl
        sidecar.istio.io/inject: "true"
      annotations:
        sidecar.istio.io/proxyCPULimit: 1000m
        sidecar.istio.io/proxyMemoryLimit: 1Gi
        sidecar.istio.io/proxyCPU: 30m
        sidecar.istio.io/proxyMemory: 64Mi
    spec:
      restartPolicy: Never
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      initContainers:
        - name: wait-for-elasticsearch
          securityContext:
            privileged: false
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsUser: 65532
            runAsNonRoot: true
            seccompProfile:
              type: RuntimeDefault
          image: ghcr.io/kaidotio/hippocampus/ephemeral-container:main
          imagePullPolicy: IfNotPresent
          command:
            - sh
          args:
            - -c
            - while ! nc -vz adhoc-elasticsearch-ingest.adhoc.svc.cluster.local. 9200 > /dev/null 2>&1; do sleep 1; done
      containers:
        - name: curl
          securityContext:
            privileged: false
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsUser: 65532
            runAsNonRoot: true
            seccompProfile:
              type: RuntimeDefault
          image: ghcr.io/kaidotio/hippocampus/ephemeral-container:main
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
          args:
            - |
              curl -sSL -XPUT -H "Content-Type: application/json" http://adhoc-elasticsearch-ingest.adhoc.svc.cluster.local.:9200/_template/template -d "@/var/curl/template.json"
              
              curl -sSL -XPUT -H "Content-Type: application/json" http://adhoc-elasticsearch-ingest.adhoc.svc.cluster.local.:9200/_ingest/pipeline/pipeline -d "@/var/curl/pipeline.yaml"
          volumeMounts:
            - name: curl
              mountPath: /var/curl
              readOnly: true
      volumes:
        - name: curl
          configMap:
            name: curl
