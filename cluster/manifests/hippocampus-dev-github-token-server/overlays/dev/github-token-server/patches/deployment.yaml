apiVersion: apps/v1
kind: Deployment
metadata:
  name: github-token-server
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 1
  template:
    spec:
      topologySpreadConstraints:
        - maxSkew: 1
          nodeAffinityPolicy: Honor
          nodeTaintsPolicy: Honor
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          matchLabelKeys:
            - pod-template-hash
          labelSelector:
            matchLabels:
              app.kubernetes.io/component: github-token-server
        - maxSkew: 1
          nodeAffinityPolicy: Honor
          nodeTaintsPolicy: Honor
          topologyKey: topology.kubernetes.io/zone
          #minDomains: 3
          #whenUnsatisfiable: DoNotSchedule
          whenUnsatisfiable: ScheduleAnyway
          matchLabelKeys:
            - pod-template-hash
          labelSelector:
            matchLabels:
              app.kubernetes.io/component: github-token-server
      containers:
        - name: github-token-server
          args:
            - --client-id=Iv23li6gN5ht5DX51aVc
            - --private-key=$(GITHUB_APP_PRIVATE_KEY)
          envFrom:
            - secretRef:
                name: hippocampus-dev-github-token-server
          env:
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: http://otel-agent.otel.svc.cluster.local:4317
            - name: OTEL_SERVICE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.labels['app.kubernetes.io/name']
            - name: OTEL_TRACES_SAMPLER
              value: parentbased_traceidratio
            - name: OTEL_TRACES_SAMPLER_ARG
              value: "1.0"
            - name: OTEL_BSP_SCHEDULE_DELAY
              value: "5000"
            - name: OTEL_BSP_EXPORT_TIMEOUT
              value: "30000"
            - name: OTEL_BSP_MAX_QUEUE_SIZE
              value: "2048"
            - name: OTEL_BSP_MAX_EXPORT_BATCH_SIZE
              value: "512"
            - name: OTEL_GO_X_EXEMPLAR
              value: "true"
            - name: OTEL_METRICS_EXEMPLAR_FILTER
              value: trace_based
            - name: PYROSCOPE_ENDPOINT
              value: http://pyroscope-distributor.pyroscope.svc.cluster.local:4040
          resources:
            requests:
              cpu: 5m
