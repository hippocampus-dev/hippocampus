name: Label translate feature
on:
  pull_request:
    types:
      - opened
  issues:
    types:
      - opened
  issue_comment:
    types:
      - created
  pull_request_review_comment:
    types:
      - created
permissions:
  pull-requests: write
  issues: write
  id-token: write
jobs:
  translate:
    if: github.repository_owner == 'kaidotio'
    timeout-minutes: 10
    runs-on: [self-hosted, github-actions-runner-controller]
    env:
      MODEL: gpt-5.2
    steps:
      - if: contains(github.event.pull_request.labels.*.name, 'translate') || contains(github.event.issue.labels.*.name, 'translate')
        run: |
          set -eo pipefail
          function cortex() {
            ID_TOKEN=$(curl -fsSL -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${GITHUB_ACTION_PATH}" | jq -re .value)
            echo "::add-mask::$ID_TOKEN" >&2
            HTTP_CODE=$(curl -sSL -w "%{http_code}" -o "${{ runner.temp }}/response.json" -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ID_TOKEN}" http://cortex-api.cortex-api.svc.cluster.local:8080/v1/chat/completions -d "$(echo $@ | jq -sc --arg model ${MODEL} '. as $messages | {model: $model, messages: $messages}')")
            if [ "$HTTP_CODE" -ge 400 ]; then
              echo "::error::$(cat "${{ runner.temp }}/response.json")" >&2
              exit 1
            fi

            if [ "$(jq -r .error "${{ runner.temp }}/response.json")" != "null" ]; then
              jq -r .error "${{ runner.temp }}/response.json" 1>&2
              exit 1
            fi

            jq -r .choices[0].message.content "${{ runner.temp }}/response.json"
          }

          systemPrompt=$(cat <<'EOS'
          Translate the given text according to the following rules.

          ## Rules
          - Translate English to Japanese
          - Translate Japanese to English
          EOS
          )

          userPrompt="${USER_PROMPT_BODY}"

          if [ -z "$userPrompt" ]; then
            exit 0
          fi

          userPrompt=$(echo "$userPrompt" | sed -r 's|<details>.*</details>||g')

          system=$(jq -n --arg role "system" --arg content "$systemPrompt" '{role: $role, content: $content}')
          user=$(jq -n --arg role "user" --arg content "$userPrompt" '{role: $role, content: $content}')
          result=$(cortex "$system" "$user")

          newComment=$(cat <<EOS
          $userPrompt

          <details>
          <summary>translate</summary>
          $result
          </details>
          EOS
          )

          curl -fsSL -X PATCH -H "Authorization: Bearer ${GITHUB_TOKEN}" "${PATCH_URL}" -d "$(jq -n --arg body "$newComment" '{body: $body}')"
        env:
          GITHUB_TOKEN: ${{ github.token }}
          USER_PROMPT_BODY: ${{ case(
              github.event_name == 'pull_request', github.event.pull_request.body,
              github.event_name == 'issues', github.event.issue.body,
              github.event_name == 'issue_comment', github.event.comment.body,
              github.event_name == 'pull_request_review_comment', github.event.comment.body,
              ''
            ) }}
          PATCH_URL: ${{ case(
              github.event_name == 'pull_request', github.event.pull_request.url,
              github.event_name == 'issues', github.event.issue.url,
              github.event_name == 'issue_comment', github.event.comment.url,
              github.event_name == 'pull_request_review_comment', github.event.comment.url,
              ''
            ) }}
