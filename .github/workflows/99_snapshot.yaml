name: Snapshot
on:
  workflow_dispatch:
    inputs:
      baseline:
        description: Baseline URL
        required: true
        default: https://example.com
      target:
        description: Target URL
        required: true
        default: https://example.com
      viewport-width:
        description: Viewport width in pixels
        required: false
        default: "1920"
      viewport-height:
        description: Viewport height in pixels
        required: false
        default: "1080"
permissions:
  contents: write
  packages: read
  actions: write
  issues: write
jobs:
  snapshot:
    if: github.repository_owner == 'kaidotio'
    uses: ./.github/workflows/reusable_snapshot.yaml
    with:
      baseline: ${{ github.event.inputs.baseline }}
      target: ${{ github.event.inputs.target }}
      headers: "{}"
      viewport-width: ${{ fromJSON(github.event.inputs.viewport-width) }}
      viewport-height: ${{ fromJSON(github.event.inputs.viewport-height) }}
  report:
    timeout-minutes: 10
    runs-on: ubuntu-24.04
    needs: snapshot
    steps:
      - uses: actions/checkout@v5
      - uses: actions/download-artifact@v7
        with:
          name: ${{ needs.snapshot.outputs.artifactName }}
          path: .snapshot
      - run: |
          baselineHtmlPath="${{ needs.snapshot.outputs.baselineHtmlPath }}"
          targetHtmlPath="${{ needs.snapshot.outputs.targetHtmlPath }}"
          baselineScreenshotPath="${{ needs.snapshot.outputs.baselineScreenshotPath }}"
          targetScreenshotPath="${{ needs.snapshot.outputs.targetScreenshotPath }}"
          screenshotDiffPath="${{ needs.snapshot.outputs.screenshotDiffPath }}"
          htmlDiffAmount="${{ needs.snapshot.outputs.htmlDiffAmount }}"
          screenshotDiffAmount="${{ needs.snapshot.outputs.screenshotDiffAmount }}"
          artifactName="${{ needs.snapshot.outputs.artifactName }}"

          BRANCH_NAME=snapshot-images-$artifactName

          git config --global user.email "kaidotio@gmail.com"
          git config --global user.name "kaidotio"

          git checkout -b $BRANCH_NAME

          rm -rf .github/.snapshot
          mv .snapshot .github/

          cp .github/$baselineHtmlPath .github/.snapshot/compare.html
          git add .github/.snapshot/compare.html
          git commit --allow-empty -m "Add baseline HTML"
          BASELINE_COMMIT=$(git rev-parse HEAD)

          cp .github/$targetHtmlPath .github/.snapshot/compare.html
          git add .github/.snapshot/compare.html
          git commit --allow-empty -m "Add target HTML"
          TARGET_COMMIT=$(git rev-parse HEAD)

          git add .github/.snapshot
          git commit -m "Upload snapshot"
          git push -f origin $BRANCH_NAME

          COMPARE_URL="https://github.com/${{ github.repository }}/compare/${BASELINE_COMMIT}...${TARGET_COMMIT}?w=1"

          BODY=$(cat <<EOS
          # Snapshot

          **Baseline URL:** ${{ github.event.inputs.baseline }}
          **Target URL:** ${{ github.event.inputs.target }}
          **実行:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          **HTML変化量:** $htmlDiffAmount
          **スクリーンショット変化量:** $screenshotDiffAmount

          ## HTML差分

          [Compare](${COMPARE_URL})

          ## スクリーンショット差分
          ![diff](https://github.com/${{ github.repository }}/blob/${BRANCH_NAME}/.github/$screenshotDiffPath?raw=true)

          ### Baseline vs Target
          <details>
          <summary>BaselineとTargetを並べて表示</summary>

          <table>
          <tr>
          <th>Baseline</th>
          <th>Target</th>
          </tr>
          <tr>
          <td><img src="https://github.com/${{ github.repository }}/blob/${BRANCH_NAME}/.github/$baselineScreenshotPath?raw=true" alt="Baseline"></td>
          <td><img src="https://github.com/${{ github.repository }}/blob/${BRANCH_NAME}/.github/$targetScreenshotPath?raw=true" alt="Target"></td>
          </tr>
          </table>
          </details>
          EOS
          )

          ISSUE_URL=$(gh issue create --title "Snapshot ${{ github.event.inputs.baseline }} vs ${{ github.event.inputs.target }}: $(date '+%Y-%m-%d %H:%M:%S')" --body "$BODY")
          echo "## Snapshot Issue Created" >> $GITHUB_STEP_SUMMARY
          echo "Issue URL: $ISSUE_URL" >> $GITHUB_STEP_SUMMARY
        env:
          GITHUB_TOKEN: ${{ github.token }}
