name: Test/github-actions-runner-controller
on:
  workflow_dispatch:
    inputs: {}
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  id-token: write
jobs:
  oidc:
    if: github.repository_owner == 'kaidotio'
    timeout-minutes: 10
    runs-on: [self-hosted, github-actions-runner-controller]
    steps:
      - run: |
          set -eo pipefail
          ID_TOKEN=$(curl -fsSL -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${GITHUB_ACTION_PATH}" | jq -re .value)
          echo "::add-mask::$ID_TOKEN"
          curl -fsSL -H "Authorization: Bearer ${ID_TOKEN}" httpbin-istio.httpbin.svc.cluster.local:8000/ip
          curl -fsSL -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${ID_TOKEN}" http://cortex-api.cortex-api.svc.cluster.local:8080/v1/chat/completions -d '{"messages":[{"role":"system","content":"hi"}]}'
  issue-github-token:
    if: github.repository_owner == 'kaidotio'
    uses: ./.github/workflows/reusable_issue-github-token.yaml
    with:
      profile: reader
    secrets: inherit
  token:
    if: github.repository_owner == 'kaidotio'
    timeout-minutes: 10
    runs-on: ubuntu-24.04
    environment: deployment
    needs: issue-github-token
    steps:
      - run: |
          TOKEN=$(echo "$ENCRYPTED_TOKEN" | base64 -d | gpg -dq --batch --passphrase "${{ secrets.GPG_PASSPHRASE }}")
          echo "::add-mask::$TOKEN"
          curl -fsSL -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $TOKEN" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/hippocampus-dev/hippocampus
        env:
          ENCRYPTED_TOKEN: ${{ needs.issue-github-token.outputs.encrypted_token }}
