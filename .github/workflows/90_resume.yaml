name: Update Resume
on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/90_resume.yaml"
      - "resume/**"
  workflow_dispatch:
    inputs: {}
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  update-resume:
    if: github.repository_owner == 'kaidotio'
    timeout-minutes: 10
    runs-on: [self-hosted, github-actions-runner-controller]
    permissions:
      contents: write
      pull-requests: write
      id-token: write
      actions: read
    steps:
      - uses: actions/checkout@v5
      - name: Configure Codex
        run: |
          set -eo pipefail
          ID_TOKEN=$(curl -fsSL -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${GITHUB_ACTION_PATH}" | jq -re .value)
          echo "::add-mask::$ID_TOKEN"
          TOKEN=$(curl -fsSL -XPOST -H "Authorization: Bearer $ID_TOKEN" "http://token-request-server.token-request-server.svc.cluster.local:8080/token" | jq -re .token)
          echo "::add-mask::$TOKEN"

          mkdir -p ${{ runner.temp }}/codex-home
          mkdir -p ${{ runner.temp }}/codex-home/.cache
          mkdir -p ${{ runner.temp }}/codex-home/.cache/gh
          cat > ${{ runner.temp }}/codex-home/config.toml << EOF
          model = "gpt-5.1"
          model_provider = "cortex"

          [sandbox_workspace_write]
          network_access = true
          writable_roots = ["${{ runner.temp }}/codex-home/.cache"]

          [shell_environment_policy]
          ignore_default_excludes = true

          [features]
          web_search_request = true

          [model_providers.cortex]
          name = "Cortex API"
          base_url = "http://cortex-api.cortex-api.svc.cluster.local:8080/v1"
          http_headers = { "Authorization" = "Bearer ${TOKEN}" }
          EOF

          echo '{"port":0}' > ${{ runner.temp }}/codex-home/${{ github.run_id }}.json
      - uses: openai/codex-action@v1
        with:
          codex-home: ${{ runner.temp }}/codex-home
          # https://github.com/openai/codex/issues/7051
          codex-version: v0.58.0
          allow-bots: true
          prompt: |
            # Task

            Analyze changes in this push and translate the resume files if necessary.

            ## Objectives

            1. Check which resume file was modified (resume/ja.md or resume/en.md)
            2. If resume/ja.md was modified, translate the changes to resume/en.md
            3. If resume/en.md was modified, translate the changes to resume/ja.md
            4. Maintain the existing structure and formatting of each file

            ## Translation Guidelines

            - Preserve markdown formatting (headers, lists, tables, links)
            - Keep proper nouns (company names, product names, URLs) unchanged
            - Maintain the same level of detail in both versions
            - Use professional language appropriate for a resume/CV

            ## Process

            - Analyze the changes in this push using git diff
            - Determine which file(s) need to be translated
            - If updates are needed, create a pull request with descriptive title and body
            - Do NOT commit directly to the main branch

            ## Important

            - Only translate when there are meaningful content changes
            - Do NOT update for formatting-only changes that don't affect meaning
            - Keep changes minimal and focused
        env:
          XDG_CACHE_HOMES: ${{ runner.temp }}/codex-home/.cache
          GH_CONFIG_DIR: ${{ runner.temp }}/codex-home/.cache/gh
          GH_TOKEN: ${{ github.token }}
  build-resume:
    if: github.repository_owner == 'kaidotio'
    timeout-minutes: 10
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v5
      - run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends pandoc
      - run: |
          make all

          BRANCH_NAME=resume-build-${{ github.run_id }}

          git config --global user.name "kaidotio"
          git config --global user.email "kaidotio@gmail.com"
          git checkout -b $BRANCH_NAME

          git add ../pages/
          if git commit -m "Build resume HTML"; then
            git push origin $BRANCH_NAME
            gh pr create --title "Build resume" --body "Automatically generated by resume workflow."
          fi
        working-directory: resume
        env:
          GH_TOKEN: ${{ github.token }}
