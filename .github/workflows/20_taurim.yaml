name: Release/taurim
on:
  release:
    types:
      - created
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: write
jobs:
  release:
    timeout-minutes: 30
    runs-on: ubuntu-24.04
    environment: deployment
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"
      - uses: android-actions/setup-android@v3
        with:
          packages: "platforms;android-36 build-tools;36.0.0"
      - uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: npm
          cache-dependency-path: taurim/package-lock.json
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android
      - uses: actions/cache@v5
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-taurim-cargo-${{ hashFiles('taurim/src-tauri/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-taurim-cargo-
      - uses: actions/cache@v5
        with:
          path: taurim/src-tauri/target
          key: ${{ runner.os }}-taurim-target-${{ hashFiles('taurim/src-tauri/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-taurim-target-
      - run: npm ci
        working-directory: taurim
      - run: npm run tauri android init
        working-directory: taurim
      - run: |
          set -eo pipefail
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > ${{ runner.temp }}/release.keystore
          echo 'apply(from = "../../../../signing.gradle.kts")' >> taurim/src-tauri/gen/android/app/build.gradle.kts
      - run: npm run tauri android build
        working-directory: taurim
        env:
          ANDROID_KEYSTORE_FILE: ${{ runner.temp }}/release.keystore
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: taurim
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_TAURIM_KEY_PASSWORD }}
      - run: |
          set -eo pipefail
          VERSION=$(echo ${{ github.event.release.tag_name }} | sed 's/^v//')
          APK_PATH=$(find src-tauri/gen/android/app/build/outputs/apk -name "*.apk" -type f | head -1)
          APK_NAME="taurim_${VERSION}_android.apk"
          mv "${APK_PATH}" "${APK_NAME}"
          gh release upload ${{ github.event.release.tag_name }} "${APK_NAME}"
        working-directory: taurim
        env:
          GITHUB_TOKEN: ${{ github.token }}
