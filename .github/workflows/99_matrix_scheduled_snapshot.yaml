name: Matrix Scheduled Snapshot
on:
  workflow_dispatch:
    inputs: {}
permissions:
  contents: write
  packages: read
  actions: write
  issues: write
  id-token: write
jobs:
  load:
    if: github.repository_owner == 'kaidotio'
    timeout-minutes: 10
    runs-on: ubuntu-24.04
    outputs:
      include: ${{ steps.load.outputs.include }}
    steps:
      - uses: actions/checkout@v5
      - id: load
        run: |
          INCLUDE='[]'
          while IFS= read -r target; do
            URL=$(echo "$target" | jq -r '.url')
            MASK_SELECTORS=$(echo "$target" | jq -r '.mask_selectors // ""')
            HEADERS=$(echo "$target" | jq -c '.headers // {}')
            VIEWPORT_WIDTH=$(echo "$target" | jq -r '.viewport.width // 1920')
            VIEWPORT_HEIGHT=$(echo "$target" | jq -r '.viewport.height // 1080')
            ARTIFACT_NAME="result-$(echo -n "${URL}_${VIEWPORT_WIDTH}x${VIEWPORT_HEIGHT}" | sha256sum | awk '{print $1}')"
            INCLUDE=$(echo "$INCLUDE" | jq --arg url "$URL" --arg maskSelectors "$MASK_SELECTORS" --arg headers "$HEADERS" --arg viewportWidth "$VIEWPORT_WIDTH" --arg viewportHeight "$VIEWPORT_HEIGHT" --arg artifactName "$ARTIFACT_NAME" '. + [{"url": $url, "maskSelectors": $maskSelectors, "headers": $headers, "viewportWidth": ($viewportWidth | tonumber), "viewportHeight": ($viewportHeight | tonumber), "artifactName": $artifactName}]')
          done < <(cat .github/workflows/99_matrix_scheduled_snapshot/config.json | jq -c '.targets[]')
          echo "include=$(echo "$INCLUDE" | jq -c .)" >> $GITHUB_OUTPUT
  snapshot:
    uses: ./.github/workflows/reusable_scheduled-snapshot.yaml
    strategy:
      max-parallel: 10
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.load.outputs.include) }}
    needs: load
    with:
      target: ${{ matrix.url }}
      mask-selectors: ${{ matrix.maskSelectors }}
      headers: ${{ matrix.headers }}
      viewport-width: ${{ matrix.viewportWidth }}
      viewport-height: ${{ matrix.viewportHeight }}
      artifact-name: ${{ matrix.artifactName }}
  report:
    timeout-minutes: 10
    runs-on: ubuntu-24.04
    needs: [snapshot, load]
    strategy:
      max-parallel: 10
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.load.outputs.include) }}
    steps:
      - uses: actions/checkout@v5
      - uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.artifactName }}
          path: .snapshot
      - run: |
          eval $(cat .snapshot/output.json | jq -r 'to_entries | .[] | "export \(.key)=\"\(.value)\""')

          if [ "$baselineHtmlPath" == "" ]; then
            BODY=$(cat <<EOS
          # Snapshot

          **対象URL:** ${{ matrix.url }}
          **実行:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOS
          )

            ISSUE_URL=$(gh issue create --title "Scheduled Snapshot ${{ matrix.url }}: $(date '+%Y-%m-%d %H:%M:%S')" --body "$BODY")
            echo "## Scheduled Snapshot Issue Created" >> $GITHUB_STEP_SUMMARY
            echo "Issue URL: $ISSUE_URL" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          BRANCH_NAME=snapshot-images-${{ matrix.artifactName }}

          git config --global user.email "kaidotio@gmail.com"
          git config --global user.name "kaidotio"

          git checkout -b $BRANCH_NAME

          rm -rf .github/.snapshot
          mv .snapshot .github/

          cp .github/$baselineHtmlPath .github/.snapshot/compare.html
          git add .github/.snapshot/compare.html
          git commit --allow-empty -m "Add baseline HTML"
          BASELINE_COMMIT=$(git rev-parse HEAD)

          cp .github/$targetHtmlPath .github/.snapshot/compare.html
          git add .github/.snapshot/compare.html
          git commit --allow-empty -m "Add target HTML"
          TARGET_COMMIT=$(git rev-parse HEAD)

          git add .github/.snapshot
          git commit -m "Upload snapshot"
          git push -f origin $BRANCH_NAME

          COMPARE_URL="https://github.com/${{ github.repository }}/compare/${BASELINE_COMMIT}...${TARGET_COMMIT}?w=1"

          BODY=$(cat <<EOS
          # Snapshot

          **対象URL:** ${{ matrix.url }}
          **実行:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          **HTML変化量:** $htmlDiffAmount
          **スクリーンショット変化量:** $screenshotDiffAmount

          ## HTML差分

          [Compare](${COMPARE_URL})

          ## スクリーンショット差分
          ![diff](https://github.com/${{ github.repository }}/blob/${BRANCH_NAME}/.github/$screenshotDiffPath?raw=true)

          ### Baseline vs Target
          <details>
            <summary>BaselineとTargetを並べて表示</summary>

            <table>
              <tr>
                <th>Baseline</th>
                <th>Target</th>
              </tr>
              <tr>
                <td><img src="https://github.com/${{ github.repository }}/blob/${BRANCH_NAME}/.github/$baselineScreenshotPath?raw=true" alt="Baseline"></td>
                <td><img src="https://github.com/${{ github.repository }}/blob/${BRANCH_NAME}/.github/$targetScreenshotPath?raw=true" alt="Target"></td>
              </tr>
            </table>
          </details>
          EOS
          )

          ISSUE_URL=$(gh issue create --title "Scheduled Snapshot ${{ matrix.url }}: $(date '+%Y-%m-%d %H:%M:%S')" --body "$BODY")
          echo "## Scheduled Snapshot ${{ matrix.url }} Issue Created" >> $GITHUB_STEP_SUMMARY
          echo "Issue URL: $ISSUE_URL" >> $GITHUB_STEP_SUMMARY
        env:
          GITHUB_TOKEN: ${{ github.token }}
