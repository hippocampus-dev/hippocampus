name: Scan mirrored images
on:
  workflow_run:
    workflows: ["Mirror docker images"]
    types:
      - completed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
  packages: read
  id-token: write
  actions: read
jobs:
  issue-github-token:
    if: |
      github.repository_owner == 'kaidotio' &&
      github.event.workflow_run.head_repository.full_name == github.repository &&
      github.event.workflow_run.conclusion == 'success'
    uses: ./.github/workflows/reusable_issue-github-token.yaml
    with:
      profile: issues
    secrets:
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
  parse:
    if: |
      github.repository_owner == 'kaidotio' &&
      github.event.workflow_run.head_repository.full_name == github.repository &&
      github.event.workflow_run.conclusion == 'success'
    timeout-minutes: 5
    runs-on: ubuntu-24.04
    outputs:
      images: ${{ steps.aggregate.outputs.images }}
      has_images: ${{ steps.aggregate.outputs.has_images }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: pushed-*
          path: ${{ runner.temp }}/artifacts
          merge-multiple: true
          github-token: ${{ github.token }}
          run-id: ${{ github.event.workflow_run.id }}
      - id: aggregate
        run: |
          set -eo pipefail
          if [ -d "${{ runner.temp }}/artifacts" ] && [ -n "$(ls -A "${{ runner.temp }}/artifacts"/*.txt 2>/dev/null)" ]; then
            images=$(cat "${{ runner.temp }}/artifacts"/*.txt | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "images=${images}" >> $GITHUB_OUTPUT
            echo "has_images=true" >> $GITHUB_OUTPUT
          else
            echo "images=[]" >> $GITHUB_OUTPUT
            echo "has_images=false" >> $GITHUB_OUTPUT
          fi
  scan:
    if: github.repository_owner == 'kaidotio' && needs.parse.outputs.has_images == 'true'
    needs: [issue-github-token, parse]
    timeout-minutes: 30
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.parse.outputs.images) }}
    steps:
      - run: docker login ghcr.io -u ${{ github.repository_owner }} -p ${{ github.token }}
      - uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ghcr.io/${{ github.repository }}/mirror/${{ matrix.image }}
          format: json
          output: trivy-results.json
          severity: CRITICAL
          exit-code: "0"
      - run: |
          set -eo pipefail

          VULNS=$(jq '[.Results // [] | .[] | .Vulnerabilities // [] | length] | add // 0' trivy-results.json)
          echo "Found $VULNS vulnerabilities in ${{ matrix.image }}"

          if [ "$VULNS" -eq 0 ]; then
            exit 0
          fi

          GH_TOKEN=$(echo "$ENCRYPTED_TOKEN" | base64 -d | gpg -dq --batch --passphrase "$GPG_PASSPHRASE")
          export GH_TOKEN

          ISSUE_TITLE="Security: Vulnerabilities in ${{ matrix.image }}"
          EXISTING=$(gh issue list --repo "${{ github.repository }}" --search "${ISSUE_TITLE} in:title is:open" --json url --jq '.[0].url // empty')

          if [ -n "$EXISTING" ]; then
            echo "Issue already exists: $EXISTING"
            exit 0
          fi

          SUMMARY=$(jq -r '
            [.Results // [] | .[] | .Vulnerabilities // [] | .[] | .Severity] |
            group_by(.) | map({(.[0]): length}) | add // {}
          ' trivy-results.json)

          BODY=$(cat <<EOF
          @claude Please triage these vulnerabilities:

          **Image:** \`ghcr.io/${{ github.repository }}/mirror/${{ matrix.image }}\`
          **Severity:** CRITICAL
          **Summary:** \`${SUMMARY}\`

          <details>
          <summary>Full scan results</summary>

          \`\`\`json
          $(cat trivy-results.json)
          \`\`\`

          </details>
          EOF
          )

          gh issue create \
            --repo "${{ github.repository }}" \
            --title "$ISSUE_TITLE" \
            --body "$BODY" \
            --label "security,trivy"
        env:
          ENCRYPTED_TOKEN: ${{ needs.issue-github-token.outputs.encrypted_token }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
