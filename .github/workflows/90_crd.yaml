name: crd
on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/90_crd.yaml"
      - ".idea/crd/kustomization.yaml"
  workflow_dispatch:
    inputs: {}
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: write
  pull-requests: write
jobs:
  deploy:
    if: github.repository_owner == 'kaidotio'
    timeout-minutes: 30
    runs-on: ubuntu-24.04
    env:
      GOPATH: /tmp/go
      GOBIN: /tmp/build-tools/bin
    steps:
      - uses: actions/checkout@v5
      - run: |
          go install sigs.k8s.io/kustomize/kustomize/v5@latest
      - run: |
          BRANCH_NAME=crd-${{ github.run_id }}

          git config --global user.name "kaidotio"
          git config --global user.email "kaidotio@gmail.com"
          git checkout -b $BRANCH_NAME

          ${GOBIN}/kustomize build . > crd.yaml
          git add crd.yaml

          if git commit -m "kustomize build"; then
            git push origin $BRANCH_NAME
            gh pr create --title "kustomize build" --body "Automatically generated by crd workflow."
          fi
        working-directory: .idea/crd
        env:
          GH_TOKEN: ${{ github.token }}
