#!/usr/bin/env bash

set -eo pipefail

function usage() {
  cat <<EOS
Usage:
   create-cve-issues.sh <trivy-results.json>

Options:
   -h, --help    Show this help
EOS
}

args=()
flags=()
while (( $# )); do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
    -*|--*)
      echo "Unsupported flag $1" 1>&2
      exit 1
      ;;
    *)
      args+=("$1")
      shift
      ;;
  esac
done

results="${args[0]:-}"

if [ ! -f "$results" ]; then
  usage 1>&2
  exit 1
fi

image=$(jq -r '.ArtifactName // empty' "$results")
if [ -z "$image" ]; then
  echo "ArtifactName not found in $results" >&2
  exit 1
fi

vulnerabilities=$(jq '[.Results // [] | .[] | .Vulnerabilities // [] | length] | add // 0' "$results")
echo "Found $vulnerabilities vulnerabilities in $image"

if [ "$vulnerabilities" -eq 0 ]; then
  exit 0
fi

cves=$(jq -r '[.Results // [] | .[] | .Vulnerabilities // [] | .[] | {VulnerabilityID, Severity, PkgName, InstalledVersion, FixedVersion, Description, PrimaryURL, CvssScore: (.CVSS // {} | to_entries | max_by(.value.V3Score // 0) | .value.V3Score // null), CvssVector: (.CVSS // {} | to_entries | max_by(.value.V3Score // 0) | .value.V3Vector // null), CweIDs: (.CweIDs // []), PublishedDate}] | unique_by(.VulnerabilityID) | .[] | @base64' "$results")

created=0
skipped=0
summary_file="${RUNNER_TEMP}/cve-issues-summary.md"

for row in $cves; do
  data=$(echo "$row" | base64 -d)
  cve_id=$(echo "$data" | jq -r '.VulnerabilityID')
  severity=$(echo "$data" | jq -r '.Severity')
  package=$(echo "$data" | jq -r '.PkgName')
  installed_version=$(echo "$data" | jq -r '.InstalledVersion')
  fixed_version=$(echo "$data" | jq -r '.FixedVersion // "none"')
  description=$(echo "$data" | jq -r '.Description // "No description available"')
  primary_url=$(echo "$data" | jq -r '.PrimaryURL // "N/A"')
  cvss_score=$(echo "$data" | jq -r '.CvssScore // "N/A"')
  cvss_vector=$(echo "$data" | jq -r '.CvssVector // "N/A"')
  cwe_ids=$(echo "$data" | jq -r '.CweIDs | if length > 0 then join(", ") else "N/A" end')
  published_date=$(echo "$data" | jq -r '.PublishedDate // "N/A"')

  title="${severity}: ${cve_id} in ${package} (${image})"

  existing=$(gh issue list --search "${cve_id} in:title is:open" --json url --jq '.[0].url // empty')
  if [ -n "$existing" ]; then
    echo "Skipping ${cve_id}: open issue exists at $existing"
    skipped=$((skipped + 1))
    continue
  fi

  body=$(cat <<EOS
@claude Please triage this vulnerability following the steps below:

**CVE:** \`${cve_id}\`
**Severity:** ${severity}
**CVSS Score:** ${cvss_score}
**CVSS Vector:** \`${cvss_vector}\`
**CWE:** ${cwe_ids}
**Published:** ${published_date}
**Package:** \`${package}\` (installed: \`${installed_version}\`, fixed: \`${fixed_version}\`)
**Image:** \`${image}\`

${description}

References:
- ${primary_url}

## Triage Steps

> **Threat model:** This is a network-facing service running on Kubernetes.
>
> | Attack Vector | Likelihood | Reason |
> |---------------|------------|--------|
> | \`AV:N\` (Network) | Primary threat | Attackers come from the network |
> | \`AV:A\` (Adjacent) | Plausible | Pod-to-pod communication within the cluster qualifies as adjacent network |
> | \`AV:L\` (Local) | Unlikely | Local runtime environment is generally trusted |
> | \`AV:P\` (Physical) | Unlikely | Physical access to infrastructure is not expected |

1. Identify the application directory from the image name
2. Check if \`${package}\` is a direct or transitive **application dependency** (Cargo.toml, Cargo.lock, go.mod, go.sum, pyproject.toml, uv.lock)
3. Determine whether this application is actually exploitable:
   - Check if the package is an application dependency or only present in the base image
   - Read the application source code to check whether the vulnerable function/feature is actually called
   - Check the CVSS Attack Vector against the threat model above
4. Take action:

| Condition | Action |
|-----------|--------|
| Not exploitable | Close this issue with \`gh issue close --reason "not planned"\` and explain why |
| Exploitable, fixed version available | Create a PR to upgrade (application dependency or base image). Reference with \`Close #N\` |
| Exploitable, no fix available | Comment with mitigation proposals. Do not close |
EOS
  )

  issue_url=$(gh issue create --title "$title" --body "$body")
  echo "Created issue for ${cve_id}: $issue_url"
  echo "- [${cve_id}](${issue_url})" >> "$summary_file"
  created=$((created + 1))
done

if [ "$created" -gt 0 ]; then
  {
    echo "## Vulnerability Issues Created: ${created}"
    cat "$summary_file"
  } >> "$GITHUB_STEP_SUMMARY"
fi

echo "Summary: created=$created, skipped=$skipped"
